path: main.go
update_behavior:
  type: skip
body: |-
  package main

  import (
    "net"

    "github.com/cloudwego/kitex/pkg/klog"
    "github.com/cloudwego/kitex/pkg/rpcinfo"
    {{- if eq .Codec "thrift"}}
    "github.com/cloudwego/kitex/pkg/transmeta"
    {{- end }}
    "github.com/cloudwego/kitex/server"
    kitexlogrus "github.com/kitex-contrib/obs-opentelemetry/logging/logrus"
    "{{.Module}}/conf"
    "{{.ImportPath}}/{{ToLower .ServiceName}}"
    "gopkg.in/natefinch/lumberjack.v2"
  )

  func main() {
    opts := kitexInit()

    svr := {{ToLower .ServiceName}}.NewServer(new({{.ServiceName}}Impl), opts...)

    err := svr.Run()
    if err != nil {
      klog.Error(err.Error())
    }
  }

  func kitexInit() (opts []server.Option) {
    // address
    addr, err := net.ResolveTCPAddr("tcp", conf.GetConf().Kitex.Address)
    if err != nil {
      panic(err)
    }
    opts = append(opts, server.WithServiceAddr(addr))

    // service info
    	opts = append(opts, server.WithServerBasicInfo(&rpcinfo.EndpointBasicInfo{
    		ServiceName: conf.GetConf().Kitex.Service,
    	}))

    {{- if eq .Codec "thrift"}}
     // thrift meta handler
     opts = append(opts, server.WithMetaHandler(transmeta.ServerTTHeaderHandler))
    {{- end}}

    // klog
    logger := kitexlogrus.NewLogger()
    klog.SetLogger(logger)
    klog.SetLevel(conf.LogLevel())
    klog.SetOutput(&lumberjack.Logger{
          		Filename:   conf.GetConf().Kitex.LogFileName,
          		MaxSize:    conf.GetConf().Kitex.LogMaxSize,
          		MaxBackups: conf.GetConf().Kitex.LogMaxBackups,
          		MaxAge:     conf.GetConf().Kitex.LogMaxAge,
          	})
    return
  }
